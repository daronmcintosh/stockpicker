syntax = "proto3";

package stockpicker.v1;

import "google/protobuf/timestamp.proto";

// Strategy service for managing trading strategies
service StrategyService {
  // Create a new strategy
  rpc CreateStrategy(CreateStrategyRequest) returns (CreateStrategyResponse);

  // List all strategies
  rpc ListStrategies(ListStrategiesRequest) returns (ListStrategiesResponse);

  // Get a specific strategy by ID
  rpc GetStrategy(GetStrategyRequest) returns (GetStrategyResponse);

  // Update a strategy
  rpc UpdateStrategy(UpdateStrategyRequest) returns (UpdateStrategyResponse);

  // Delete a strategy
  rpc DeleteStrategy(DeleteStrategyRequest) returns (DeleteStrategyResponse);

  // Start a strategy (activate trading)
  rpc StartStrategy(StartStrategyRequest) returns (StartStrategyResponse);

  // Pause a strategy (stop trading but keep tracking)
  rpc PauseStrategy(PauseStrategyRequest) returns (PauseStrategyResponse);

  // Stop a strategy (permanently end)
  rpc StopStrategy(StopStrategyRequest) returns (StopStrategyResponse);

  // Manually trigger prediction generation for a strategy
  rpc TriggerPredictions(TriggerPredictionsRequest) returns (TriggerPredictionsResponse);

  // Internal: Prepare data for n8n workflow execution (called by n8n workflows)
  rpc PrepareDataForWorkflow(PrepareDataForWorkflowRequest) returns (PrepareDataForWorkflowResponse);

  // Internal: Create predictions from workflow output (called by n8n workflows)
  rpc CreatePredictionsFromWorkflow(CreatePredictionsFromWorkflowRequest) returns (CreatePredictionsFromWorkflowResponse);

  // Get workflow runs for a strategy
  rpc ListWorkflowRuns(ListWorkflowRunsRequest) returns (ListWorkflowRunsResponse);

  // Get a specific workflow run
  rpc GetWorkflowRun(GetWorkflowRunRequest) returns (GetWorkflowRunResponse);

  // Update strategy privacy (public/private)
  rpc UpdateStrategyPrivacy(UpdateStrategyPrivacyRequest) returns (UpdateStrategyPrivacyResponse);

  // Auth RPCs
  rpc SendOTP(SendOTPRequest) returns (SendOTPResponse);
  rpc VerifyOTP(VerifyOTPRequest) returns (VerifyOTPResponse);
  rpc GetCurrentUser(GetCurrentUserRequest) returns (GetCurrentUserResponse);
  rpc UpdateUser(UpdateUserRequest) returns (UpdateUserResponse);

  // Social RPCs
  rpc FollowUser(FollowUserRequest) returns (FollowUserResponse);
  rpc UnfollowUser(UnfollowUserRequest) returns (UnfollowUserResponse);
  rpc ListFollowing(ListFollowingRequest) returns (ListFollowingResponse);
  rpc ListFollowers(ListFollowersRequest) returns (ListFollowersResponse);
  rpc ListCloseFriends(ListCloseFriendsRequest) returns (ListCloseFriendsResponse);
  rpc GetUserProfile(GetUserProfileRequest) returns (GetUserProfileResponse);

  // Performance & Leaderboard RPCs
  rpc GetUserPerformance(GetUserPerformanceRequest) returns (GetUserPerformanceResponse);
  rpc GetLeaderboard(GetLeaderboardRequest) returns (GetLeaderboardResponse);

  // Sharing RPCs
  rpc CopyStrategy(CopyStrategyRequest) returns (CopyStrategyResponse);
}

// Prediction service for managing stock predictions
service PredictionService {
  // Create a new prediction
  rpc CreatePrediction(CreatePredictionRequest) returns (CreatePredictionResponse);

  // List predictions for a strategy
  rpc ListPredictions(ListPredictionsRequest) returns (ListPredictionsResponse);

  // Get a specific prediction
  rpc GetPrediction(GetPredictionRequest) returns (GetPredictionResponse);

  // Get predictions by symbol
  rpc GetPredictionsBySymbol(GetPredictionsBySymbolRequest) returns (GetPredictionsBySymbolResponse);

  // Update prediction action (pending/entered/dismissed)
  rpc UpdatePredictionAction(UpdatePredictionActionRequest) returns (UpdatePredictionActionResponse);

  // Get public predictions (sorted by most recent)
  rpc GetPublicPredictions(GetPublicPredictionsRequest) returns (GetPublicPredictionsResponse);

  // Update prediction privacy (public/private)
  rpc UpdatePredictionPrivacy(UpdatePredictionPrivacyRequest) returns (UpdatePredictionPrivacyResponse);

  // Update prediction fields
  rpc UpdatePrediction(UpdatePredictionRequest) returns (UpdatePredictionResponse);

  // Get current stock prices for symbols
  rpc GetCurrentPrices(GetCurrentPricesRequest) returns (GetCurrentPricesResponse);

  // Delete a prediction
  rpc DeletePrediction(DeletePredictionRequest) returns (DeletePredictionResponse);

  // Sharing RPCs
  rpc CopyPrediction(CopyPredictionRequest) returns (CopyPredictionResponse);
}


// Strategy status enum
enum StrategyStatus {
  STRATEGY_STATUS_UNSPECIFIED = 0;
  STRATEGY_STATUS_ACTIVE = 1;
  STRATEGY_STATUS_PAUSED = 2;
  STRATEGY_STATUS_STOPPED = 3;
}

// Risk level enum
enum RiskLevel {
  RISK_LEVEL_UNSPECIFIED = 0;
  RISK_LEVEL_LOW = 1;
  RISK_LEVEL_MEDIUM = 2;
  RISK_LEVEL_HIGH = 3;
}

// Frequency enum
enum Frequency {
  FREQUENCY_UNSPECIFIED = 0;
  FREQUENCY_DAILY = 1;
  FREQUENCY_TWICE_WEEKLY = 2;
  FREQUENCY_WEEKLY = 3;
  FREQUENCY_BIWEEKLY = 4;
  FREQUENCY_MONTHLY = 5;
}

// Strategy message
message Strategy {
  string id = 1;
  string name = 2;
  string description = 3;
  string custom_prompt = 4;

  // Budget configuration
  double monthly_budget = 5;
  double current_month_spent = 6;
  google.protobuf.Timestamp current_month_start = 7;

  // Trading configuration
  string time_horizon = 8;
  double target_return_pct = 9;
  Frequency frequency = 10;
  int32 trades_per_month = 11;
  double per_trade_budget = 12;
  double per_stock_allocation = 13;
  RiskLevel risk_level = 14;

  // Portfolio limits
  int32 unique_stocks_count = 15;
  int32 max_unique_stocks = 16;

  // Status
  StrategyStatus status = 17;
  google.protobuf.Timestamp next_trade_scheduled = 18;
  google.protobuf.Timestamp last_trade_executed = 19;

  // Timestamps
  google.protobuf.Timestamp created_at = 20;
  google.protobuf.Timestamp updated_at = 21;

  // Privacy
  StrategyPrivacy privacy = 22;

  // User (gamification)
  string user_id = 23;
  optional User user = 24; // Populated in list/get responses

  // AI Agent configuration (JSON string: array of model names, e.g., ["gpt-4o-mini", "gpt-4o", "gpt-4o-mini"])
  optional string ai_agents = 25;
}

// Create Strategy
message CreateStrategyRequest {
  string name = 1;
  string description = 2;
  string custom_prompt = 3;
  double monthly_budget = 4;
  string time_horizon = 5;
  double target_return_pct = 6;
  Frequency frequency = 7;
  RiskLevel risk_level = 8;
  int32 max_unique_stocks = 9;
  optional string ai_agents = 10; // JSON array of model names (e.g., ["gpt-4o-mini", "gpt-4o"])
}

message CreateStrategyResponse {
  Strategy strategy = 1;
}

// List Strategies
message ListStrategiesRequest {
  // Optional filtering
  StrategyStatus status = 1;
}

message ListStrategiesResponse {
  repeated Strategy strategies = 1;
}

// Get Strategy
message GetStrategyRequest {
  string id = 1;
}

message GetStrategyResponse {
  Strategy strategy = 1;
}

// Update Strategy
message UpdateStrategyRequest {
  string id = 1;
  optional string name = 2;
  optional string description = 3;
  optional string custom_prompt = 4;
  optional string time_horizon = 5;
  optional double target_return_pct = 6;
  optional RiskLevel risk_level = 7;
  optional int32 max_unique_stocks = 8;
  optional string ai_agents = 9; // JSON string: array of model names
}

message UpdateStrategyResponse {
  Strategy strategy = 1;
}

// Delete Strategy
message DeleteStrategyRequest {
  string id = 1;
}

message DeleteStrategyResponse {
  bool success = 1;
}

// Start Strategy
message StartStrategyRequest {
  string id = 1;
}

message StartStrategyResponse {
  Strategy strategy = 1;
}

// Pause Strategy
message PauseStrategyRequest {
  string id = 1;
}

message PauseStrategyResponse {
  Strategy strategy = 1;
}

// Stop Strategy
message StopStrategyRequest {
  string id = 1;
}

message StopStrategyResponse {
  Strategy strategy = 1;
}

// Trigger Predictions
message TriggerPredictionsRequest {
  string id = 1; // Strategy ID
}

message TriggerPredictionsResponse {
  bool success = 1;
  string message = 2; // Status message (e.g., "Predictions generation triggered successfully")
}

// Prepare Data For Workflow (Internal - called by n8n workflows)
message PrepareDataForWorkflowRequest {
  string id = 1; // Strategy ID
}

message PrepareDataForWorkflowResponse {
  StrategyData strategy = 1;
  repeated ActivePredictionData active_predictions = 2;
  BudgetData budget = 3; // Detailed budget information for investment guidance
  string sources = 4; // JSON-encoded source data structure
}

message BudgetData {
  double monthly_budget = 1; // Total monthly budget allocated for this strategy
  double current_month_spent = 2; // Amount already spent this month
  double remaining_budget = 3; // Available budget remaining (monthly_budget - current_month_spent)
  double per_stock_allocation = 4; // Amount allocated per stock prediction
  int32 available_slots = 5; // Number of stocks that can be funded with remaining budget (floor(remaining_budget / per_stock_allocation))
  bool has_budget = 6; // Quick check: true if remaining_budget > 0
  double budget_utilization_pct = 7; // Percentage of monthly budget used (current_month_spent / monthly_budget * 100)
}

message StrategyData {
  string id = 1;
  string name = 2;
  string time_horizon = 3;
  double target_return_pct = 4;
  RiskLevel risk_level = 5;
  double per_stock_allocation = 6;
  string custom_prompt = 7;
}

message ActivePredictionData {
  string id = 1;
  string symbol = 2;
  double allocated_amount = 3;
}

// Create Predictions From Workflow (Internal - called by n8n workflows)
message CreatePredictionsFromWorkflowRequest {
  string strategy_id = 1;
  string json_output = 2; // JSON string containing recommendations
  string markdown_output = 3; // Markdown report
  optional string execution_id = 4; // n8n execution ID
  optional string input_data = 5; // JSON string of input data sent to workflow (sources, strategy, etc.)
  optional string ai_analysis = 6; // JSON string of raw AI analysis output
}

message CreatePredictionsFromWorkflowResponse {
  bool success = 1;
  string workflow_run_id = 2;
  int32 predictions_created = 3;
  repeated CreatedPredictionData predictions = 4;
}

message CreatedPredictionData {
  string id = 1;
  string symbol = 2;
  double entry_price = 3;
  double target_price = 4;
  double stop_loss_price = 5;
}

// Update Workflow Run Status (Internal - called by n8n workflows on error)
message UpdateWorkflowRunStatusRequest {
  string strategy_id = 1;
  optional string execution_id = 2; // n8n execution ID
  string status = 3; // 'failed' or 'completed'
  optional string error_message = 4; // Error message if status is 'failed'
}

message UpdateWorkflowRunStatusResponse {
  bool success = 1;
  optional string workflow_run_id = 2;
}

// Workflow Runs
message ListWorkflowRunsRequest {
  string strategy_id = 1;
  optional int32 limit = 2; // Max number of runs to return (default: 50)
  optional int32 offset = 3; // Pagination offset (default: 0)
}

message ListWorkflowRunsResponse {
  repeated WorkflowRun workflow_runs = 1;
  int32 total = 2; // Total count of workflow runs
}

message GetWorkflowRunRequest {
  string id = 1;
}

message GetWorkflowRunResponse {
  WorkflowRun workflow_run = 1;
}

message WorkflowRun {
  string id = 1;
  string strategy_id = 2;
  optional string execution_id = 3; // n8n execution ID
  optional string input_data = 4; // JSON string of input data sent to workflow
  optional string ai_analysis = 5; // JSON string of raw AI analysis output
  optional string json_output = 6; // JSON string of structured output (null if failed)
  optional string markdown_output = 7; // Markdown string for UI rendering (null if failed)
  string status = 8; // pending, running, completed, failed
  optional string error_message = 9; // Error message if status is failed
  google.protobuf.Timestamp created_at = 10;
  google.protobuf.Timestamp updated_at = 11;
}

// ============================================================================
// PREDICTION SERVICE MESSAGES
// ============================================================================

// Prediction action enum
enum PredictionAction {
  PREDICTION_ACTION_UNSPECIFIED = 0;
  PREDICTION_ACTION_PENDING = 1;
  PREDICTION_ACTION_ENTERED = 2;
  PREDICTION_ACTION_DISMISSED = 3;
}

// Prediction status enum
enum PredictionStatus {
  PREDICTION_STATUS_UNSPECIFIED = 0;
  PREDICTION_STATUS_ACTIVE = 1;
  PREDICTION_STATUS_HIT_TARGET = 2;
  PREDICTION_STATUS_HIT_STOP = 3;
  PREDICTION_STATUS_EXPIRED = 4;
}

// Prediction privacy enum
enum PredictionPrivacy {
  PREDICTION_PRIVACY_UNSPECIFIED = 0;
  PREDICTION_PRIVACY_PRIVATE = 1;
  PREDICTION_PRIVACY_PUBLIC = 2;
}

// Prediction source enum
enum PredictionSource {
  PREDICTION_SOURCE_UNSPECIFIED = 0;
  PREDICTION_SOURCE_AI = 1;
  PREDICTION_SOURCE_MANUAL = 2;
}

// Strategy privacy enum
enum StrategyPrivacy {
  STRATEGY_PRIVACY_UNSPECIFIED = 0;
  STRATEGY_PRIVACY_PRIVATE = 1;
  STRATEGY_PRIVACY_PUBLIC = 2;
}

// Prediction message
message Prediction {
  string id = 1;
  string strategy_id = 2;
  string symbol = 3;
  double entry_price = 4;
  double allocated_amount = 5;
  int32 time_horizon_days = 6;
  google.protobuf.Timestamp evaluation_date = 7;
  double target_return_pct = 8;
  double target_price = 9;
  double stop_loss_pct = 10;
  double stop_loss_price = 11;
  double stop_loss_dollar_impact = 12;
  RiskLevel risk_level = 13;
  string technical_analysis = 14; // JSON string
  double sentiment_score = 15;
  double overall_score = 16;
  PredictionAction action = 17;
  PredictionStatus status = 18;
  optional double current_price = 19;
  optional double current_return_pct = 20;
  optional google.protobuf.Timestamp closed_at = 21;
  optional string closed_reason = 22;
  google.protobuf.Timestamp created_at = 23;
  PredictionPrivacy privacy = 24;
  PredictionSource source = 25; // AI-generated or manually created
  string user_id = 26; // User who owns this prediction
  optional User user = 27; // Populated in list/get responses
  optional string ai_models = 28; // JSON array of model names that suggested this prediction (e.g., ["gpt-4o", "gpt-4o-mini"])
}

// List Predictions
message ListPredictionsRequest {
  string strategy_id = 1;
  optional PredictionStatus status = 2;
}

message ListPredictionsResponse {
  repeated Prediction predictions = 1;
}

// Get Prediction
message GetPredictionRequest {
  string id = 1;
}

message GetPredictionResponse {
  Prediction prediction = 1;
}

// Get Predictions by Symbol
message GetPredictionsBySymbolRequest {
  string symbol = 1;
  optional string strategy_id = 2;
}

message GetPredictionsBySymbolResponse {
  repeated Prediction predictions = 1;
}

// Create Prediction
message CreatePredictionRequest {
  string strategy_id = 1;
  string symbol = 2;
  double entry_price = 3;
  double allocated_amount = 4;
  double target_price = 5;
  double stop_loss_price = 6;
  string technical_analysis = 7; // JSON string
  double sentiment_score = 8;
  double overall_score = 9;
  optional int32 time_horizon_days = 10;
  optional double target_return_pct = 11;
  optional double stop_loss_pct = 12;
  optional RiskLevel risk_level = 13;
  optional PredictionSource source = 14; // AI-generated or manually created
}

message CreatePredictionResponse {
  Prediction prediction = 1;
}

// Update Prediction Action
message UpdatePredictionActionRequest {
  string id = 1;
  PredictionAction action = 2;
}

message UpdatePredictionActionResponse {
  Prediction prediction = 1;
}

// Get Public Predictions
message GetPublicPredictionsRequest {
  optional int32 limit = 1; // Max number of predictions to return (default: 50)
  optional int32 offset = 2; // Pagination offset (default: 0)
}

message GetPublicPredictionsResponse {
  repeated Prediction predictions = 1;
  int32 total = 2; // Total count of public predictions
}

// Update Prediction Privacy
message UpdatePredictionPrivacyRequest {
  string id = 1;
  PredictionPrivacy privacy = 2;
}

message UpdatePredictionPrivacyResponse {
  Prediction prediction = 1;
}

// Update Prediction
message UpdatePredictionRequest {
  string id = 1;
  optional string symbol = 2;
  optional double entry_price = 3;
  optional double allocated_amount = 4;
  optional double target_price = 5;
  optional double stop_loss_price = 6;
  optional double sentiment_score = 7;
  optional double overall_score = 8;
  optional string technical_analysis = 9;
  optional int32 time_horizon_days = 10;
  optional RiskLevel risk_level = 11;
}

message UpdatePredictionResponse {
  Prediction prediction = 1;
}

// Update Strategy Privacy
message UpdateStrategyPrivacyRequest {
  string id = 1;
  StrategyPrivacy privacy = 2;
}

message UpdateStrategyPrivacyResponse {
  Strategy strategy = 1;
}

// Get Current Prices
message GetCurrentPricesRequest {
  repeated string symbols = 1; // List of stock symbols to fetch prices for
}

message GetCurrentPricesResponse {
  map<string, double> prices = 1; // Map of symbol to current price
}

// Delete Prediction
message DeletePredictionRequest {
  string id = 1; // Prediction ID to delete
}

message DeletePredictionResponse {
  bool success = 1;
}

// ============================================================================
// GAMIFICATION: USER, AUTH, SOCIAL, PERFORMANCE, LEADERBOARD
// ============================================================================

// User message
message User {
  string id = 1;
  string email = 2;
  string username = 3;
  string display_name = 4;
  optional string avatar_url = 5;
  google.protobuf.Timestamp created_at = 6;
  google.protobuf.Timestamp updated_at = 7;
}

// --- AUTH MESSAGES ---

message SendOTPRequest {
  string email = 1;
}

message SendOTPResponse {
  bool success = 1;
  string message = 2;
}

message VerifyOTPRequest {
  string email = 1;
  string otp_code = 2;
}

message VerifyOTPResponse {
  bool success = 1;
  optional User user = 2;
  optional string token = 3; // JWT token
}

message GetCurrentUserRequest {}

message GetCurrentUserResponse {
  optional User user = 1;
}

message UpdateUserRequest {
  optional string username = 1;
  optional string display_name = 2;
  optional string avatar_url = 3;
}

message UpdateUserResponse {
  User user = 1;
}

// --- SOCIAL MESSAGES ---

message FollowUserRequest {
  string user_id = 1; // User to follow
}

message FollowUserResponse {
  bool success = 1;
}

message UnfollowUserRequest {
  string user_id = 1; // User to unfollow
}

message UnfollowUserResponse {
  bool success = 1;
}

message ListFollowingRequest {
  optional string user_id = 1; // If empty, current user
}

message ListFollowingResponse {
  repeated User users = 1;
}

message ListFollowersRequest {
  optional string user_id = 1; // If empty, current user
}

message ListFollowersResponse {
  repeated User users = 1;
}

message ListCloseFriendsRequest {}

message ListCloseFriendsResponse {
  repeated User users = 1;
}

message GetUserProfileRequest {
  string username = 1;
}

message GetUserProfileResponse {
  User user = 1;
  bool is_following = 2; // Current user follows this user
  bool is_followed_by = 3; // This user follows current user
  bool is_close_friend = 4; // Mutual follow
  UserPerformance performance = 5;
}

// --- PERFORMANCE & LEADERBOARD MESSAGES ---

message UserPerformance {
  string user_id = 1;
  int32 total_predictions = 2;
  int32 closed_predictions = 3;
  int32 wins = 4;
  double win_rate = 5; // Percentage (0-100)
  double avg_return = 6; // Average return percentage
  double total_roi = 7; // Sum of all returns
  int32 current_streak = 8; // Consecutive wins
  optional Prediction best_prediction = 9;
}

enum LeaderboardTimeframe {
  LEADERBOARD_TIMEFRAME_UNSPECIFIED = 0;
  LEADERBOARD_TIMEFRAME_ALL_TIME = 1;
  LEADERBOARD_TIMEFRAME_MONTHLY = 2;
}

enum LeaderboardScope {
  LEADERBOARD_SCOPE_UNSPECIFIED = 0;
  LEADERBOARD_SCOPE_GLOBAL = 1;
  LEADERBOARD_SCOPE_FOLLOWING = 2;
  LEADERBOARD_SCOPE_CLOSE_FRIENDS = 3;
}

message LeaderboardEntry {
  int32 rank = 1;
  User user = 2;
  double performance_score = 3;
  UserPerformance performance = 4;
}

message GetLeaderboardRequest {
  LeaderboardTimeframe timeframe = 1;
  LeaderboardScope scope = 2;
  optional int32 limit = 3; // Default 50
  optional int32 offset = 4; // Default 0
}

message GetLeaderboardResponse {
  repeated LeaderboardEntry entries = 1;
  int32 total_count = 2;
  optional LeaderboardEntry current_user_entry = 3; // User's position
}

message GetUserPerformanceRequest {
  optional string user_id = 1; // If empty, current user
  LeaderboardTimeframe timeframe = 2;
}

message GetUserPerformanceResponse {
  UserPerformance performance = 1;
}

// --- SHARING MESSAGES ---

message CopyStrategyRequest {
  string strategy_id = 1; // Strategy to copy
}

message CopyStrategyResponse {
  Strategy strategy = 1; // New copied strategy
}

message CopyPredictionRequest {
  string prediction_id = 1; // Prediction to copy
  string strategy_id = 2; // Target strategy to copy the prediction to
}

message CopyPredictionResponse {
  Prediction prediction = 1; // New copied prediction
}
